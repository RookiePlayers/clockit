# Google Cloud Build configuration for clockit-server (WebSocket)
steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/clockit-socket:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/clockit-socket:latest'
      - '-f'
      - 'clockit-server/Dockerfile'
      - 'clockit-server'

  # Push the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/clockit-socket:$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/clockit-socket:latest'

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail
        REDIS_URL="${_REDIS_URL:-}"
        FIREBASE_B64="${_FIREBASE_SERVICE_ACCOUNT_B64:-}"
        API_BASE_URL="${_API_BASE_URL:-}"
        ALLOWED_ORIGINS="${_ALLOWED_ORIGINS:-}"
        RATE_LIMIT_WINDOW_MS="${_RATE_LIMIT_WINDOW_MS:-}"
        RATE_LIMIT_MAX_REQUESTS="${_RATE_LIMIT_MAX_REQUESTS:-}"
        LOG_LEVEL="${_LOG_LEVEL:-info}"
        ENABLE_ADMIN_SETUP="${_ENABLE_ADMIN_SETUP:-false}"
        ADMIN_SETUP_TOKEN="${_ADMIN_SETUP_TOKEN:-}"
        INITIAL_ADMIN_EMAILS="${_INITIAL_ADMIN_EMAILS:-}"
        ENV_VARS="NODE_ENV=production"
        if [ -n "$REDIS_URL" ]; then
          ENV_VARS="$ENV_VARS,REDIS_URL=$REDIS_URL"
        fi

        gcloud run deploy clockit-socket \
          --image "gcr.io/$PROJECT_ID/clockit-socket:$COMMIT_SHA" \
          --region "europe-west4" \
          --platform "managed" \
          --allow-unauthenticated \
          --set-env-vars "$ENV_VARS" \
          --max-instances "10" \
          --min-instances "0" \
          --memory "512Mi" \
          --cpu "1" \
          --timeout "3600s" \
          --session-affinity

images:
  - 'gcr.io/$PROJECT_ID/clockit-socket:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/clockit-socket:latest'

options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
